{% extends "base-auth.html" %}

{% block title %}Reset Password - {{ app_name }}{% endblock %}

{% block extra_css %}
<style>
  /* ==================== MINIMAL CUSTOM STYLES ==================== */
  body {
    background-color: #f9fafb;
  }

  .reset-container {
    min-height: calc(100vh - 72px);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .reset-card {
    max-width: 480px;
    width: 100%;
  }

  .password-toggle {
    cursor: pointer;
    color: #6b7280;
  }

  .password-toggle:hover {
    color: #1d4ed8;
  }

  .password-strength {
    height: 4px;
    border-radius: 2px;
    background: #e5e7eb;
    overflow: hidden;
    margin-top: 8px;
  }

  .password-strength-bar {
    height: 100%;
    transition: all 0.3s;
    width: 0%;
  }

  .password-strength-bar.weak {
    background: #ef4444;
    width: 33%;
  }

  .password-strength-bar.medium {
    background: #f59e0b;
    width: 66%;
  }

  .password-strength-bar.strong {
    background: #22c55e;
    width: 100%;
  }

  @media (max-width: 576px) {
    .reset-container {
      padding: 1rem;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container reset-container">
  <div class="reset-card">
    
    <!-- Card -->
    <div class="card border-0 shadow-sm rounded-3">
      <div class="card-body p-4 p-md-5">
        
        <!-- Icon -->
        <div class="text-center mb-4">
          <div class="mb-3">
            <!--<i class="bi bi-shield-lock text-primary" style="font-size: 3rem;"></i>  -->
          </div>
          <h2 class="fw-bold mb-2" id="resetTitle" style="text-align: left;">Reset your password</h2>
          <p class="text-muted small mb-0" id="resetSubtitle" style="text-align: left;">
            Change your password
          </p>
          <!--<p class="text-primary small fw-semibold mb-0" id="userEmail"></p>  -->
        </div>

        <!-- Reset Password Form -->
        <form id="resetForm">
          
          <!-- New Password -->
          <div class="mb-3">
            <label for="password" class="form-label fw-semibold" id="passwordLabel">Password</label>
            <div class="input-group">
              <span class="input-group-text bg-white">
                <i class="bi bi-lock text-muted"></i>
              </span>
              <input 
                type="password" 
                class="form-control border-start-0 border-end-0" 
                id="password"
                name="password"
                placeholder="Enter new password" 
                required
              />
              <button 
                class="btn border bg-white password-toggle" 
                type="button"
                onclick="togglePassword('password', this)"
                tabindex="-1"
              >
                <i class="bi bi-eye"></i>
              </button>
            </div>
            <br/>
            <!-- Password Strength Indicator 
            <div class="password-strength">
              <div class="password-strength-bar" id="strengthBar"></div>
            </div>
            <small class="text-muted d-block mt-2" id="strengthText">
              Password must be at least 8 characters
            </small>
          </div>-->

          <!-- Confirm Password -->
          <div class="mb-4">
            <label for="confirmPassword" class="form-label fw-semibold" id="confirmLabel">Confirm Password</label>
            <div class="input-group">
              <span class="input-group-text bg-white">
                <i class="bi bi-shield-lock text-muted"></i>
              </span>
              <input 
                type="password" 
                class="form-control border-start-0 border-end-0" 
                id="confirmPassword"
                name="confirmPassword"
                placeholder="Confirm new password" 
                required
              />
              <button 
                class="btn border bg-white password-toggle" 
                type="button"
                onclick="togglePassword('confirmPassword', this)"
                tabindex="-1"
              >
                <i class="bi bi-eye"></i>
              </button>
            </div>
            <div class="invalid-feedback" id="matchError">
              Passwords do not match
            </div>
          </div>

          <!-- Password Requirements -->
          <!--<div class="alert alert-light border mb-4">
            <small class="text-muted fw-semibold d-block mb-2">Password must contain:</small>
            <ul class="small text-muted mb-0 ps-3" style="line-height: 1.8;">
              <li id="req-length">At least 8 characters</li>
              <li id="req-upper">One uppercase letter (A-Z)</li>
              <li id="req-lower">One lowercase letter (a-z)</li>
              <li id="req-number">One number (0-9)</li>
              <li id="req-special">One special character (!@#$%^&*)</li>
            </ul>
          </div> -->

          <!-- Submit Button -->
          <div class="d-grid mb-3">
            <button type="submit" class="btn btn-primary rounded-pill py-3 fw-semibold" id="submitBtn">
              Reset Password
            </button>
          </div>

          <!-- Back to Login Link -->
          <div class="text-center">
            <a href="/login" class="text-primary text-decoration-none fw-semibold">
              <i class="bi bi-arrow-left me-1"></i>
              Back to Login
            </a>
          </div>

        </form>

      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // ==================== PASSWORD TOGGLE ====================
  function togglePassword(id, el) {
    const input = document.getElementById(id);
    const icon = el.querySelector("i");
    
    if (input.type === "password") {
      input.type = "text";
      icon.classList.replace("bi-eye", "bi-eye-slash");
    } else {
      input.type = "password";
      icon.classList.replace("bi-eye-slash", "bi-eye");
    }
  }

  // ==================== FLOW VERIFICATION ====================
  // Verify user came from OTP verification
  const authFlow = localStorage.getItem('authFlow');
  const userEmail = localStorage.getItem('userEmail');

  // Display email
  if (userEmail) {
    document.getElementById('userEmail').textContent = userEmail;
  }

  // Security check - redirect if not from forgot-password flow
  if (authFlow !== 'forgot-password') {
    console.warn('Unauthorized access to reset password page');
    // In production, redirect to forgot-password
    // window.location.href = '/forget-pass';
  }

  // ==================== PASSWORD STRENGTH CHECKER ====================
  const passwordInput = document.getElementById('password');
  const strengthBar = document.getElementById('strengthBar');
  const strengthText = document.getElementById('strengthText');

  const requirements = {
    length: { regex: /.{8,}/, element: document.getElementById('req-length') },
    upper: { regex: /[A-Z]/, element: document.getElementById('req-upper') },
    lower: { regex: /[a-z]/, element: document.getElementById('req-lower') },
    number: { regex: /[0-9]/, element: document.getElementById('req-number') },
    special: { regex: /[!@#$%^&*(),.?":{}|<>]/, element: document.getElementById('req-special') }
  };

  passwordInput.addEventListener('input', function() {
    const password = this.value;
    let score = 0;
    let metRequirements = 0;

    // Check each requirement
    Object.keys(requirements).forEach(key => {
      const req = requirements[key];
      const met = req.regex.test(password);
      
      if (met) {
        score++;
        metRequirements++;
        req.element.classList.add('text-success');
        req.element.classList.remove('text-muted');
        req.element.innerHTML = `<i class="bi bi-check-circle-fill me-1"></i>${req.element.textContent.replace(/✓\s*/, '')}`;
      } else {
        req.element.classList.remove('text-success');
        req.element.classList.add('text-muted');
        req.element.innerHTML = req.element.textContent.replace(/✓\s*/, '').replace(/<[^>]*>/g, '');
      }
    });

    // Update strength bar
    strengthBar.className = 'password-strength-bar';
    
    if (score === 0) {
      strengthBar.style.width = '0%';
      strengthText.textContent = 'Password must be at least 8 characters';
      strengthText.className = 'text-muted d-block mt-2';
    } else if (score <= 2) {
      strengthBar.classList.add('weak');
      strengthText.textContent = 'Weak password';
      strengthText.className = 'text-danger d-block mt-2';
    } else if (score <= 4) {
      strengthBar.classList.add('medium');
      strengthText.textContent = 'Medium strength password';
      strengthText.className = 'text-warning d-block mt-2';
    } else {
      strengthBar.classList.add('strong');
      strengthText.textContent = 'Strong password';
      strengthText.className = 'text-success d-block mt-2';
    }
  });

  // ==================== PASSWORD MATCH VALIDATION ====================
  const confirmPasswordInput = document.getElementById('confirmPassword');
  const matchError = document.getElementById('matchError');

  function checkPasswordMatch() {
    const password = passwordInput.value;
    const confirmPassword = confirmPasswordInput.value;

    if (confirmPassword.length > 0) {
      if (password !== confirmPassword) {
        confirmPasswordInput.classList.add('is-invalid');
        matchError.style.display = 'block';
      } else {
        confirmPasswordInput.classList.remove('is-invalid');
        matchError.style.display = 'none';
      }
    }
  }

  confirmPasswordInput.addEventListener('input', checkPasswordMatch);
  passwordInput.addEventListener('input', function() {
    if (confirmPasswordInput.value.length > 0) {
      checkPasswordMatch();
    }
  });

  // ==================== MULTI-LANGUAGE SUPPORT ====================
  const lang = localStorage.getItem("lang") || "en";

  const translations = {
    en: {
      title: "Reset your password",
      subtitle: "Create a strong password for your account",
      passwordLabel: "New Password",
      confirmLabel: "Confirm Password",
      submitBtn: "Reset Password",
      strengthWeak: "Weak password",
      strengthMedium: "Medium strength password",
      strengthStrong: "Strong password",
      requirementsTitle: "Password must contain:",
      backToLogin: "Back to Login"
    },
    ms: {
      title: "Tetapkan semula kata laluan anda",
      subtitle: "Buat kata laluan yang kukuh untuk akaun anda",
      passwordLabel: "Kata Laluan Baharu",
      confirmLabel: "Sahkan Kata Laluan",
      submitBtn: "Tetapkan Semula Kata Laluan",
      strengthWeak: "Kata laluan lemah",
      strengthMedium: "Kata laluan sederhana",
      strengthStrong: "Kata laluan kukuh",
      requirementsTitle: "Kata laluan mesti mengandungi:",
      backToLogin: "Kembali ke Log Masuk"
    },
    th: {
      title: "รีเซ็ตรหัสผ่านของคุณ",
      subtitle: "สร้างรหัสผ่านที่แข็งแกร่งสำหรับบัญชีของคุณ",
      passwordLabel: "รหัสผ่านใหม่",
      confirmLabel: "ยืนยันรหัสผ่าน",
      submitBtn: "รีเซ็ตรหัสผ่าน",
      strengthWeak: "รหัสผ่านอ่อนแอ",
      strengthMedium: "รหัสผ่านปานกลาง",
      strengthStrong: "รหัสผ่านแข็งแกร่ง",
      requirementsTitle: "รหัสผ่านต้องมี:",
      backToLogin: "กลับไปเข้าสู่ระบบ"
    },
    id: {
      title: "Reset kata sandi Anda",
      subtitle: "Buat kata sandi yang kuat untuk akun Anda",
      passwordLabel: "Kata Sandi Baru",
      confirmLabel: "Konfirmasi Kata Sandi",
      submitBtn: "Reset Kata Sandi",
      strengthWeak: "Kata sandi lemah",
      strengthMedium: "Kata sandi sedang",
      strengthStrong: "Kata sandi kuat",
      requirementsTitle: "Kata sandi harus mengandung:",
      backToLogin: "Kembali ke Login"
    }
  };

  // Apply language (optional - can be implemented)
  // const t = translations[lang];
  // ...

  // ==================== FORM SUBMISSION WITH FLOW CONTROL ====================
  document.getElementById('resetForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const password = passwordInput.value;
    const confirmPassword = confirmPasswordInput.value;

    // Validate password strength
    let allRequirementsMet = true;
    Object.keys(requirements).forEach(key => {
      if (!requirements[key].regex.test(password)) {
        allRequirementsMet = false;
      }
    });

    if (!allRequirementsMet) {
      alert('Please meet all password requirements');
      return;
    }

    // Validate passwords match
    if (password !== confirmPassword) {
      alert('Passwords do not match');
      confirmPasswordInput.focus();
      return;
    }

    console.log('Resetting password for:', userEmail);
    
    // Show loading state
    const submitBtn = document.getElementById('submitBtn');
    const originalText = submitBtn.textContent;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Resetting...';
    submitBtn.disabled = true;

    // In production: Send to backend
    // fetch('/api/reset-password', {
    //   method: 'POST',
    //   headers: { 'Content-Type': 'application/json' },
    //   body: JSON.stringify({ 
    //     email: userEmail,
    //     password: password,
    //     token: sessionStorage.getItem('reset_token')
    //   })
    // })
    // .then(response => response.json())
    // .then(data => {
    //   if (data.success) {
    //     // Clear flow data
    //     localStorage.removeItem('authFlow');
    //     localStorage.removeItem('userEmail');
    //     sessionStorage.removeItem('reset_token');
    //     
    //     alert('Password reset successfully! Please login with your new password.');
    //     window.location.href = '/login';
    //   } else {
    //     alert('Error resetting password. Please try again.');
    //     submitBtn.textContent = originalText;
    //     submitBtn.disabled = false;
    //   }
    // })
    // .catch(error => {
    //   alert('Error resetting password. Please try again.');
    //   submitBtn.textContent = originalText;
    //   submitBtn.disabled = false;
    // });

    // For demo: Simulate API call
    setTimeout(() => {
      // Clear flow data
      localStorage.removeItem('authFlow');
      localStorage.removeItem('userEmail');
      
      alert('Password reset successfully! Please login with your new password.');
      window.location.href = '/login';
    }, 1500);
  });
</script>
{% endblock %}